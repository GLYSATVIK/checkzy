{
  "version": 3,
  "sources": ["../src/background.ts"],
  "sourcesContent": ["// Background Service Worker\r\n\r\n// Initialize Context Menu\r\nchrome.runtime.onInstalled.addListener(() => {\r\n    chrome.contextMenus.removeAll(() => {\r\n        chrome.contextMenus.create({\r\n            id: \"checkzy-open\",\r\n            title: \"Checkzy AI: Improve Text\",\r\n            contexts: [\"selection\"]\r\n        });\r\n    });\r\n});\r\n\r\nchrome.contextMenus.onClicked.addListener(async (info, tab) => {\r\n    if (info.menuItemId === \"checkzy-open\" && tab?.id) {\r\n        const text = info.selectionText;\r\n        try {\r\n            await chrome.tabs.sendMessage(tab.id, {\r\n                action: \"OPEN_DIALOG\",\r\n                text: text\r\n            });\r\n        } catch (err) {\r\n            // If message fails (e.g. content script not loaded), inject and retry\r\n            console.log(\"Injection fallback triggered\");\r\n            await chrome.scripting.executeScript({\r\n                target: { tabId: tab.id },\r\n                files: [\"content.js\"]\r\n            });\r\n            // Initializing delay to let script load\r\n            await new Promise(r => setTimeout(r, 100));\r\n            await chrome.tabs.sendMessage(tab.id, {\r\n                action: \"OPEN_DIALOG\",\r\n                text: text\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\nchrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {\r\n    if (msg.action === 'GENERATE') {\r\n        handleGenerate(msg).then(sendResponse);\r\n        return true; // async response\r\n    }\r\n});\r\n\r\nasync function handleGenerate(msg: any) {\r\n    const { prompt, model, text } = msg;\r\n\r\n    try {\r\n        const keys = await chrome.storage.local.get(['openai_key', 'anthropic_key', 'gemini_key', 'straico_key', 'openrouter_key']);\r\n\r\n        // Route to provider based on model prefix or name\r\n        if (model.startsWith('gpt')) {\r\n            return await callOpenAI(keys.openai_key, model, prompt, text);\r\n        } else if (model.startsWith('claude')) {\r\n            return await callAnthropic(keys.anthropic_key, model, prompt, text);\r\n        } else if (model.startsWith('gemini')) {\r\n            return await callGemini(keys.gemini_key, model, prompt, text);\r\n        } else {\r\n            // Default to OpenRouter for everything else? Or Check Straico?\r\n            // For MVP, simplistic routing.\r\n            return { error: 'Unknown model provider' };\r\n        }\r\n    } catch (e: any) {\r\n        return { error: e.message || 'API Error' };\r\n    }\r\n}\r\n\r\n// --- API Clients ---\r\n\r\nasync function callOpenAI(key: string, model: string, prompt: string, text: string) {\r\n    if (!key) return { error: 'Missing OpenAI API Key' };\r\n    const res = await fetch('https://api.openai.com/v1/chat/completions', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },\r\n        body: JSON.stringify({\r\n            model: model,\r\n            messages: [\r\n                { role: 'system', content: `You are a text editing engine. \"${prompt}\". Return ONLY the final rewritten text. Do NOT include explanations, \"Here is\", quotes, or markdown. Just the raw text.` },\r\n                { role: 'user', content: text }\r\n            ]\r\n        })\r\n    });\r\n    if (!res.ok) {\r\n        const err = await res.json();\r\n        throw new Error(err.error?.message || 'OpenAI Error');\r\n    }\r\n    const data = await res.json();\r\n    return { text: data.choices[0].message.content };\r\n}\r\n\r\nasync function callAnthropic(key: string, model: string, prompt: string, text: string) {\r\n    if (!key) return { error: 'Missing Anthropic API Key' };\r\n    const res = await fetch('https://api.anthropic.com/v1/messages', {\r\n        method: 'POST',\r\n        headers: { 'x-api-key': key, 'anthropic-version': '2023-06-01', 'content-type': 'application/json' },\r\n        body: JSON.stringify({\r\n            model: model,\r\n            max_tokens: 1024,\r\n            system: `You are a text editing engine. \"${prompt}\". Return ONLY the final rewritten text. Do NOT include explanations, \"Here is\", quotes, or markdown. Just the raw text.`,\r\n            messages: [{ role: 'user', content: text }]\r\n        })\r\n    });\r\n    if (!res.ok) {\r\n        const err = await res.json();\r\n        throw new Error(err.error?.message || 'Anthropic Error');\r\n    }\r\n    const data = await res.json();\r\n    return { text: data.content[0].text };\r\n}\r\n\r\nasync function callGemini(key: string, model: string, prompt: string, text: string) {\r\n    if (!key) return { error: 'Missing Gemini API Key' };\r\n\r\n    const tryFetch = async (modelName: string) => {\r\n        // Ensure model name doesn't have double 'models/' prefix\r\n        const cleanName = modelName.replace(/^models\\//, '');\r\n        const url = `https://generativelanguage.googleapis.com/v1beta/models/${cleanName}:generateContent?key=${key}`;\r\n\r\n        const res = await fetch(url, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                // Strict Prompt Tuning for Gemini\r\n                contents: [{ parts: [{ text: `Task: ${prompt}. Text: \"${text}\". \\n\\nDirectives: Return ONLY the rewritten text. NO explanations. NO markdown blocks. NO \"Here is\". Just the result.` }] }]\r\n            })\r\n        });\r\n        return res;\r\n    };\r\n\r\n    // 1. Try requested model\r\n    let res = await tryFetch(model);\r\n\r\n    // 2. Auto-discover allowed models if 404 (Not Found) or 503 (Overloaded)\r\n    if (!res.ok && (res.status === 404 || res.status === 503)) {\r\n        console.log(`[Checkzy] Gemini model ${model} status ${res.status}. Auto-discovering/switching models...`);\r\n\r\n        // If overloaded, wait a bit before trying fallback\r\n        if (res.status === 503) await new Promise(r => setTimeout(r, 1000));\r\n\r\n        try {\r\n            const listRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);\r\n            if (listRes.ok) {\r\n                const listData = await listRes.json();\r\n                // Find first model supporting generateContent\r\n                // Prioritize 'gemini-1.5-flash' or 'gemini-pro' if available and not the one that just failed\r\n                const models = listData.models || [];\r\n                const validModel = models.find((m: any) =>\r\n                    m.name !== `models/${model}` &&\r\n                    m.supportedGenerationMethods?.includes('generateContent')\r\n                );\r\n\r\n                if (validModel) {\r\n                    console.log(`[Checkzy] Falling back to: ${validModel.name}`);\r\n                    res = await tryFetch(validModel.name);\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error('[Checkzy] Model discovery failed', e);\r\n        }\r\n    }\r\n\r\n    if (!res.ok) {\r\n        const err = await res.json();\r\n        throw new Error(err.error?.message || 'Gemini Error');\r\n    }\r\n    const data = await res.json();\r\n\r\n    // Safety check for response structure\r\n    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {\r\n        throw new Error('Unexpected Gemini response format');\r\n    }\r\n\r\n    return { text: data.candidates[0].content.parts[0].text };\r\n}\r\n"],
  "mappings": "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",
  "names": ["res"]
}
